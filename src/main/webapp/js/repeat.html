<!doctype html>
<html lang="en">
<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
	
	<script src="common.js"></script>

	<title>TimeRec: Service repeat</title>
</head>
<body>

<nav id="navMenuContainer" style="background-color: #e3f2fd; display:block; height: 56px;"></nav>

<!-- CONTENT -->
<style>
.container .row input[type="text"] { color: black; }
.container .row input::placeholder { color: gray; }
</style>
<div class="container" style="display:none">
  <form role="form" class="sRepeat">
    <h1 id="hMain">Repeat of service</h1>
  	<hr>
	<div class="row">
      <!-- left column -->
      <div class="col-md-1"></div>
      
      <!-- right column -->
      <div class="col-md-11">
        <div id="alertMessage"></div>
		
		<h3 id="hDOW">Day of week</h3>

        <div class="row">
          <label id="ld1" class="col-lg-2 d-flex p-2 control-label">Monday</label>
          <div class="col-lg-2">
            <input id="day1from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day1to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day1duration" class="form-control" type="text" placeholder="">
          </div>
        </div>
		
        <div class="row">
          <label id="ld2" class="col-lg-2 d-flex p-2 control-label">Tuesday</label>
          <div class="col-lg-2">
            <input id="day2from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day2to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day2duration" class="form-control" type="text" placeholder="">
          </div>
        </div>
		
        <div class="row">
          <label id="ld3" class="col-lg-2 d-flex p-2 control-label">Wednesday</label>
          <div class="col-lg-2">
            <input id="day3from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day3to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day3duration" class="form-control" type="text" placeholder="">
          </div>
        </div>
		
        <div class="row">
          <label id="ld4" class="col-lg-2 d-flex p-2 control-label">Thursday</label>
          <div class="col-lg-2">
            <input id="day4from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day4to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day4duration" class="form-control" type="text" placeholder="">
          </div>
        </div>
		
        <div class="row">
          <label id="ld5" class="col-lg-2 d-flex p-2 control-label">Friday</label>
          <div class="col-lg-2">
            <input id="day5from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day5to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day5duration" class="form-control" type="text" placeholder="">
          </div>
        </div>
		
        <div class="row">
          <label id="ld6" class="col-lg-2 d-flex p-2 control-label">Saturday</label>
          <div class="col-lg-2">
            <input id="day6from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day6to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day6duration" class="form-control" type="text" placeholder="">
          </div>
        </div>
		
        <div class="row">
          <label id="ld7" class="col-lg-2 d-flex p-2">Sunday</label>
          <div class="col-lg-2">
            <input id="day7from" class="form-control" type="text" placeholder="9:00">
          </div>
          <label class="col-lg-1 d-flex justify-content-center p-2">-</label>
          <div class="col-lg-2">
            <input id="day7to" class="form-control" type="text" placeholder="18:00">
          </div>
          <label class="col-lg-1 d-flex p-2 DUR">duration</label>
          <div class="col-lg-2">
            <input id="day7duration" class="form-control" type="text" placeholder="">
          </div>
        </div>

		<div class="form-group">
		  <label class="col-lg-5 control-label"></label>
		  <div class="col-lg-8">
			<span></span>
            <input id="bSave" type="button" class="btn btn-primary" value="Save Changes" onclick="postData(); return false;">
            <span></span>
            <input id="bCancel" type="reset" class="btn btn-default" value="Cancel" onclick="getData(); return false;">
		  </div>
		</div>
      </div>
    </div>
  </form>
</div>
<script>

API_URL = "/timerec/api/" + "repeat/service/";
SERVICE_ID = null;
DEF_DURATION = 30;

var DOWS = [];
DOWS[1] = 'Monday';
DOWS[2] = 'Tuesday';
DOWS[3] = 'Wednesday';
DOWS[4] = 'Thursday';
DOWS[5] = 'Friday';
DOWS[6] = 'Saturday';
DOWS[7] = 'Sunday';

MSG_NO_PARAM = 'Parameter service_id is not set';
MSG_DAY_TIME_ERR_FROM = ' FROM time';
MSG_DAY_TIME_ERR_TO = ' TO time';
MSG_FROM_GREATER_TO = ', FROM time must be less than TO time';
MSG_DURATION_NOT_NUM = ', duration must be numeric';
MSG_DURATION_BIG = ', duration(min) must be less than 1 day';
MSG_WRONG_FORMAT = 'must be HH:MM';
MSG_WRONG_HOURS = 'hours must be between 0 and 24';
MSG_WRONG_MINUTES = 'minutes must be between 0 and 59';
MSG_WRONG_H24 = 'when hours = 24, minutes must be = 0';
MSG_SAVED = 'Repeats saved successfully';

function translateForm() {
  if(USER_LANG == 'ru-RU') {
    DOWS[1] = 'Понедельник';
    DOWS[2] = 'Вторник';
    DOWS[3] = 'Среда';
    DOWS[4] = 'Четверг';
    DOWS[5] = 'Пятница';
    DOWS[6] = 'Суббота';
    DOWS[7] = 'Воскресенье';
    title = 'Повтор услуги';
    document.title = 'TimeRec: '+title;
    $('#hMain').text(title);
    $('#hDOW').text('Дни недели');
    $('#bSave').prop('value', 'Сохранить изменения');
    $('#bCancel').prop('value', 'Отменить');
    $('.DUR').each(function() {
      $( this ).text('длительность');
    });
    MSG_NO_PARAM = 'Параметр service_id не установлен';
    MSG_DAY_TIME_ERR_FROM = ' время ОТ';
    MSG_DAY_TIME_ERR_TO = ' время ДО';
    MSG_FROM_GREATER_TO = ', время ОТ должно быть меньше, чем время ДО';
    MSG_DURATION_NOT_NUM = ', длительность должна быть числом';
    MSG_DURATION_BIG = ', длительность(мин) должна быть меньше 1 дня';
    MSG_WRONG_FORMAT = 'должно быть HH:MM';
    MSG_WRONG_HOURS = 'часы должны быть в интервале от 0 до 24';
    MSG_WRONG_MINUTES = 'минуты должны быть в интервале от 0 до 59';
    MSG_WRONG_H24 = 'когда часы указаны 24, минуты должны быть равны 0';
    MSG_SAVED = 'Повторы сохранены успешно';
  }
  for (i = 1; i <= 7; i++) {
    $('#ld' + i).text(DOWS[i]);
  }
}

/*ROW_PATTERN =
 '   <div class="row">  '  +
 '     <label class="col-lg-2 d-flex p-2">{name}:</label>  '  +
 '     <div class="col-lg-2">  '  +
 '       <input id="day7from" class="form-control" type="text" placeholder="9:00">  '  +
 '     </div>  '  +
 '     <label class="col-lg-1 d-flex justify-content-center p-2">-</label>  '  +
 '     <div class="col-lg-2">  '  +
 '       <input id="day7to" class="form-control" type="text" placeholder="18:00">  '  +
 '     </div>  '  +
 '     <label class="col-lg-1 d-flex p-2">duration</label>  '  +
 '     <div class="col-lg-2">  '  +
 '       <input id="day7duration" class="form-control" type="text" placeholder="30">  '  +
 '     </div>  '  +
 '  </div>  ';*/

function cleanTable() {
    for (i = 1; i <= 7; i++) {
        $( "#day" + i + "from" ).val( "" );
        $( "#day" + i + "to" ).val( "" );
        $( "#day" + i + "duration" ).val( "" );
    }
}
function fillTable(data) {
    if( data.length > 0 ) {
        data.forEach(function(i){
            $( "#day" + i.dow + "from" ).val( timeFromSeconds(i.time_from) );
            $( "#day" + i.dow + "to" ).val( timeFromSeconds(i.time_to) );
            $( "#day" + i.dow + "duration" ).val( i.duration );
        });
        for (i = 1; i <= 7; i++) {
            $( "#day" + i + "from" ).attr("placeholder", "");
            $( "#day" + i + "to" ).attr("placeholder", "");
            $( "#day" + i + "duration" ).attr("placeholder", "");
        }
    } else {
        for (i = 1; i <= 7; i++) {
            $( "#day" + i + "duration" ).attr("placeholder", DEF_DURATION);
        }
    }
}
function readTable() {
    var data = [];
    for (i = 1; i <= 7; i++) {
      f = timeToSeconds( $( "#day" + i + "from" ).val() );
      t = timeToSeconds( $( "#day" + i + "to" ).val() );
      d = $( "#day" + i + "duration" ).val();
      if( f > -1 && t > -1 ) {
        if( (0 + d) == 0 ) {
            d = DEF_DURATION;
            $( "#day" + i + "duration" ).val( d );
        }
        data.push({
          dow: i,
          time_from: f,
          time_to: t,
          duration: d
        });
      }
    }
    return data;
}

function getData() {
	SERVICE_ID = getUrlVars()["service_id"];
	if( SERVICE_ID == null ) {
		errorText = MSG_NO_PARAM;
		$( ".container" ).html( '<br><br><h4>' + errorText + '</h4>' );
		alert( errorText );
		$( ".container" ).show();
		return;
	}
	var url = API_URL + SERVICE_ID + "?_=" + (new Date()).getTime();
	getAjaxJson({
		url: url,
		done: function( data ) {
			if(data && data.service && data.service.duration && data.service.duration > 0)
			    DEF_DURATION = data.service.duration;
			cleanTable();
			fillTable(data.repeat);
			$( ".container" ).show();
		}
	});
}

function checkData() {
	alertMessageHide();

    for (i = 1; i <= 7; i++) {
        f = $( "#day" + i + "from" ).val();
        t = $( "#day" + i + "to" ).val();
        fs = timeToSeconds( f, DOWS[i] + MSG_DAY_TIME_ERR_FROM );
        ts = timeToSeconds( t, DOWS[i] + MSG_DAY_TIME_ERR_TO );
        if( fs >= ts && f !== '' && t != '' ) {
            alertMessage( "''" + DOWS[i] + "''" + MSG_FROM_GREATER_TO );
            return false;
        }
        d = $( "#day" + i + "duration" ).val();
        if( !( 0 + d > -1 ) ) {
            alertMessage( "''" + DOWS[i] + "''" + MSG_DURATION_NOT_NUM );
            return false;
        }
        if( d >= 60 * 24 ) {
            alertMessage( "''" + DOWS[i] + "''" + MSG_DURATION_BIG );
            return false;
        }
    }
	return true;
}

function timeToSeconds(strTime, description) {
    if( !( strTime ) ) return -1;
	var regex = /(\d{1,2}):(\d{1,2})/;
	var match;
    if ((match = regex.exec(strTime)) === null) {
		alertMessage( "''" + description + "'' " + MSG_WRONG_FORMAT );
        throw "checkIsTime: Time is bad!";
    }
    var h = +match[1];
    var m = +match[2];
    if( h < 0 || h > 24 ) {
		alertMessage( "''" + description + "'' " + MSG_WRONG_HOURS );
        throw "checkIsTime: Hours is bad!";
    }
    if( m < 0 || m > 59 ) {
		alertMessage( "''" + description + "'' " + MSG_WRONG_MINUTES );
        throw "checkIsTime: Minutes is bad!";
    }
    if( h == 24 && m != 0 ) {
		alertMessage( "''" + description + "'' " + MSG_WRONG_H24 );
        throw "checkIsTime: Night is bad!";
    }
    var seconds = h * 60 * 60 + m * 60;
    return seconds;
}

function timeFromSeconds(seconds) {
	var h = (seconds / 60 / 60) >>> 0; // divide and truncate
    var m = ((seconds / 60) >>> 0) - (h * 60);
    hh = ( h < 10 ? '0' : '' ) + h;
    mm = ( m < 10 ? '0' : '' ) + m;
    return hh + ':' + mm;
}

function postData() {
	if( !checkData() ) return false;
	SERVICE_ID = getUrlVars()["service_id"];
	var url = API_URL + SERVICE_ID;
	getAjaxJson({
		method: "PUT",
		url: url,
		data: JSON.stringify(
		    readTable()
		),
		done: function( data ) {
			alertMessage( MSG_SAVED );
		}
	})
}

document.addEventListener( 'DOMContentLoaded', function(){ translateForm(); getData() } );
</script>
<!-- /CONTENT -->

	<hr>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
  </body>
</html>